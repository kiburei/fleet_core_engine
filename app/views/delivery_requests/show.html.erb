<% content_for :header do %>
  <%= render "rui/shared/admin/nav", { header_title: "Delivery Request ##{@delivery_request.request_number || @delivery_request.id}" } do %>
    <div class="flex items-center gap-3">
      <div class="flex items-center space-x-3">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
          <%= case @delivery_request.status
              when 'pending' then 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'
              when 'assigned' then 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400'
              when 'picked_up' then 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400'
              when 'in_transit' then 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400'
              when 'delivered' then 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400'
              when 'cancelled' then 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400'
              else 'bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-400'
              end %>">
          <%= @delivery_request.status.humanize %>
        </span>
        
        <% if @delivery_request.priority != 'normal' %>
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
            <%= @delivery_request.priority == 'urgent' ? 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400' : 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400' %>">
            <%= @delivery_request.priority.humanize %> Priority
          </span>
        <% end %>
      </div>
      <%= link_to "Back to Deliveries", delivery_requests_path, class: "btn btn-secondary" %>
    </div>
  <% end %>
<% end %>

<% content_for :title, "Delivery Request ##{@delivery_request.request_number || @delivery_request.id}" %>

<div class="px-4 mb-16">
  <div class="container mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Customer & Fleet Info -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h2 class="text-lg font-medium text-slate-900 dark:text-white mb-4">Customer & Fleet Information</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Customer</label>
              <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.customer&.name || "N/A" %></p>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Fleet Provider</label>
              <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.fleet_provider.name %></p>
            </div>
          </div>
        </div>

        <!-- Pickup Information -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h2 class="text-lg font-medium text-slate-900 dark:text-white mb-4 flex items-center">
            <%= icon "map-pin", class: "size-5 mr-2 text-green-600 dark:text-green-400" %>
            Pickup Location
          </h2>
          
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Address</label>
              <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.pickup_address %></p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Contact Name</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.pickup_contact_name || "N/A" %></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Contact Phone</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white">
                  <% if @delivery_request.pickup_contact_phone %>
                    <a href="tel:<%= @delivery_request.pickup_contact_phone %>" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">
                      <%= @delivery_request.pickup_contact_phone %>
                    </a>
                  <% else %>
                    N/A
                  <% end %>
                </p>
              </div>
            </div>
            
            <% if @delivery_request.pickup_instructions.present? %>
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Pickup Instructions</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.pickup_instructions %></p>
              </div>
            <% end %>
            
            <div class="grid grid-cols-2 gap-4 text-xs text-slate-500 dark:text-slate-400">
              <div>Lat: <%= @delivery_request.pickup_latitude %></div>
              <div>Lng: <%= @delivery_request.pickup_longitude %></div>
            </div>
          </div>
        </div>

        <!-- Delivery Information -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h2 class="text-lg font-medium text-slate-900 dark:text-white mb-4 flex items-center">
            <%= icon "map-pin", class: "size-5 mr-2 text-primary-600 dark:text-primary-400" %>
            Delivery Location
          </h2>
          
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Address</label>
              <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.delivery_address %></p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Contact Name</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.delivery_contact_name || "N/A" %></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Contact Phone</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white">
                  <% if @delivery_request.delivery_contact_phone %>
                    <a href="tel:<%= @delivery_request.delivery_contact_phone %>" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">
                      <%= @delivery_request.delivery_contact_phone %>
                    </a>
                  <% else %>
                    N/A
                  <% end %>
                </p>
              </div>
            </div>
            
            <% if @delivery_request.delivery_instructions.present? %>
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Delivery Instructions</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.delivery_instructions %></p>
              </div>
            <% end %>
            
            <div class="grid grid-cols-2 gap-4 text-xs text-slate-500 dark:text-slate-400">
              <div>Lat: <%= @delivery_request.delivery_latitude %></div>
              <div>Lng: <%= @delivery_request.delivery_longitude %></div>
            </div>
          </div>
        </div>

        <!-- Delivery Timeline -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h2 class="text-lg font-medium text-slate-900 dark:text-white mb-4">Delivery Timeline</h2>
          
          <div class="flow-root">
            <ul class="-mb-8">
              <li>
                <div class="relative pb-8">
                  <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-slate-200 dark:bg-slate-600" aria-hidden="true"></span>
                  <div class="relative flex space-x-3">
                    <div>
                      <span class="h-8 w-8 rounded-full bg-primary-500 flex items-center justify-center ring-8 ring-white dark:ring-slate-800">
                        <%= icon "check-circle", class: "size-4 text-white" %>
                      </span>
                    </div>
                    <div class="min-w-0 flex-1 pt-1.5">
                      <div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Request Created</p>
                        <p class="text-xs text-slate-400 dark:text-slate-500"><%= @delivery_request.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
                      </div>
                    </div>
                  </div>
                </div>
              </li>

              <% if @delivery_request.assigned_at %>
                <li>
                  <div class="relative pb-8">
                    <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-slate-200 dark:bg-slate-600" aria-hidden="true"></span>
                    <div class="relative flex space-x-3">
                      <div>
                        <span class="h-8 w-8 rounded-full bg-green-500 flex items-center justify-center ring-8 ring-white dark:ring-slate-800">
                          <%= icon "check-circle", class: "size-4 text-white" %>
                        </span>
                      </div>
                      <div class="min-w-0 flex-1 pt-1.5">
                        <div>
                          <p class="text-sm text-slate-500 dark:text-slate-400">Assigned to <%= @delivery_request.driver&.full_name || "Driver" %></p>
                          <p class="text-xs text-slate-400 dark:text-slate-500"><%= @delivery_request.assigned_at.strftime("%B %d, %Y at %I:%M %p") %></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
              <% end %>

              <% if @delivery_request.picked_up_at %>
                <li>
                  <div class="relative pb-8">
                    <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-slate-200 dark:bg-slate-600" aria-hidden="true"></span>
                    <div class="relative flex space-x-3">
                      <div>
                        <span class="h-8 w-8 rounded-full bg-yellow-500 flex items-center justify-center ring-8 ring-white dark:ring-slate-800">
                          <%= icon "check-circle", class: "size-4 text-white" %>
                        </span>
                      </div>
                      <div class="min-w-0 flex-1 pt-1.5">
                        <div>
                          <p class="text-sm text-slate-500 dark:text-slate-400">Package Picked Up</p>
                          <p class="text-xs text-slate-400 dark:text-slate-500"><%= @delivery_request.picked_up_at.strftime("%B %d, %Y at %I:%M %p") %></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
              <% end %>

              <% if @delivery_request.delivered_at %>
                <li>
                  <div class="relative">
                    <div class="relative flex space-x-3">
                      <div>
                        <span class="h-8 w-8 rounded-full bg-green-600 flex items-center justify-center ring-8 ring-white dark:ring-slate-800">
                          <%= icon "check-circle", class: "size-4 text-white" %>
                        </span>
                      </div>
                      <div class="min-w-0 flex-1 pt-1.5">
                        <div>
                          <p class="text-sm text-slate-500 dark:text-slate-400">Delivery Completed</p>
                          <p class="text-xs text-slate-400 dark:text-slate-500"><%= @delivery_request.delivered_at.strftime("%B %d, %Y at %I:%M %p") %></p>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
              <% end %>

              <% if @delivery_request.status == 'cancelled' %>
                <li>
                  <div class="relative">
                    <div class="relative flex space-x-3">
                      <div>
                        <span class="h-8 w-8 rounded-full bg-red-500 flex items-center justify-center ring-8 ring-white dark:ring-slate-800">
                          <%= icon "x-mark", class: "size-4 text-white" %>
                        </span>
                      </div>
                      <div class="min-w-0 flex-1 pt-1.5">
                        <div>
                          <p class="text-sm text-slate-500 dark:text-slate-400">Delivery Cancelled</p>
                          <% if @delivery_request.cancelled_at %>
                            <p class="text-xs text-slate-400 dark:text-slate-500"><%= @delivery_request.cancelled_at.strftime("%B %d, %Y at %I:%M %p") %></p>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Driver Information -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">Driver Information</h3>
          
          <% if @delivery_request.driver %>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Name</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.driver.full_name %></p>
              </div>
              
              <% if @delivery_request.driver.respond_to?(:phone) %>
                <div>
                  <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Phone</label>
                  <p class="mt-1 text-sm text-slate-900 dark:text-white">
                    <a href="tel:<%= @delivery_request.driver.phone %>" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">
                      <%= @delivery_request.driver.phone %>
                    </a>
                  </p>
                </div>
              <% elsif @delivery_request.driver.respond_to?(:phone_number) %>
                <div>
                  <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Phone</label>
                  <p class="mt-1 text-sm text-slate-900 dark:text-white">
                    <a href="tel:<%= @delivery_request.driver.phone_number %>" class="text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300">
                      <%= @delivery_request.driver.phone_number %>
                    </a>
                  </p>
                </div>
              <% end %>
              
              <% if @delivery_request.driver.respond_to?(:status) %>
                <div>
                  <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Status</label>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                    <%= case @delivery_request.driver.status
                        when 'online' then 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400'
                        when 'offline' then 'bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-400'
                        when 'busy' then 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'
                        else 'bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-400'
                        end %>">
                    <%= @delivery_request.driver.status.humanize %>
                  </span>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-slate-500 dark:text-slate-400">No driver assigned</p>
          <% end %>
        </div>

        <!-- Delivery Details -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">Delivery Details</h3>
          
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Fee</label>
              <p class="mt-1 text-lg font-semibold text-slate-900 dark:text-white">$<%= @delivery_request.delivery_fee %></p>
            </div>
            
            <% if @delivery_request.estimated_distance_km %>
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Distance</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.estimated_distance_km %> km</p>
              </div>
            <% end %>
            
            <% if @delivery_request.estimated_duration_minutes %>
              <div>
                <label class="block text-sm font-medium text-slate-500 dark:text-slate-400">Est. Duration</label>
                <p class="mt-1 text-sm text-slate-900 dark:text-white"><%= @delivery_request.estimated_duration_minutes %> minutes</p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Actions -->
        <div class="bg-white dark:bg-slate-800 shadow border border-slate-200 dark:border-slate-600/80 rounded-lg p-6">
          <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">Actions</h3>
          
          <div class="space-y-2">
            <% if respond_to?(:edit_delivery_request_path) %>
              <%= link_to "Edit Delivery", edit_delivery_request_path(@delivery_request), class: "btn btn-primary w-full" %>
            <% end %>
            
            <% if @delivery_request.respond_to?(:can_be_cancelled?) && @delivery_request.can_be_cancelled? %>
              <%= button_to "Cancel Delivery", delivery_request_path(@delivery_request),
                  method: :patch,
                  params: { delivery_request: { status: 'cancelled' } },
                  class: "btn btn-danger w-full",
                  confirm: "Are you sure you want to cancel this delivery?" %>
            <% end %>
            
            <%= link_to "Back to Deliveries", delivery_requests_path, class: "btn btn-secondary w-full" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>